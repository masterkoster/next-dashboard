generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  engineType    = "library"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid()) @db.NVarChar(36)
  username         String   @unique @db.NVarChar(50)
  email            String   @unique @db.NVarChar(255)
  name             String?  @db.NVarChar(255)
  image            String?  @db.NVarChar(500)
  purchasedModules String   @default("[]") @db.NVarChar(Max)
  credits          Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  password         String?  @db.NVarChar(255)

  // E2EE (public key only; private key stays client-side)
  e2eePublicKeyJwk       String? @db.NVarChar(Max)
  e2eePublicKeyUpdatedAt DateTime?

  // Email verification
  emailVerified     DateTime?
  verifyToken       String?   @db.NVarChar(255)
  verifyTokenExpiry DateTime?

  // Password reset
  resetToken       String?   @db.NVarChar(255)
  resetTokenExpiry DateTime?

  // Role for admin access
  role String @default("user") @db.NVarChar(20) // user, admin, owner

  // Subscription fields
  tier                 String    @default("free") @db.NVarChar(20) // free, pro
  stripeCustomerId     String?   @db.NVarChar(100)
  stripeSubscriptionId String?   @db.NVarChar(100)
  subscriptionEnd      DateTime?
  homeState            String?   @db.NVarChar(2)

  // Pilot credentials
  bfrExpiry      DateTime?
  medicalExpiry  DateTime?
  medicalClass   String?   @db.NVarChar(10) // "1", "2", "3"

  flightPlans         FlightPlan[]
  memberships         GroupMember[]
  aircraft            UserAircraft[]
  documents           Document[]
  errorReports        ErrorReport[]
  trainingProgress    TrainingProgress?
  trainingGoal        TrainingGoal?
  trainingFinancials  TrainingFinancials?
  logbookEntries      LogbookEntry[]
  flightTracks        FlightTrack[]
  marketplaceListings MarketplaceListing[]
  pilotProfile        PilotProfile?
  userContact         UserContact?
  pilotMedical        PilotMedical?
  pilotLicenses       PilotLicense[]
  userPreferences     UserPreferences?
  userNotificationSettings UserNotificationSettings?
  groupMemberSettings GroupMemberSettings[]
  mechanicProfile    Mechanic?
  maintenanceRequests MaintenanceRequest[] @relation("UserMaintenanceRequests")
  friendRequestsSent     FriendRequest[]       @relation("FriendRequestRequester")
  friendRequestsReceived FriendRequest[]       @relation("FriendRequestRecipient")
  conversationParticipants ConversationParticipant[]
  messages               Message[]
  presence               UserPresence?
  aircraftInquiries      AircraftInquiry[]
  engineDataUploads     EngineDataUpload[]
  engineAnomalies       EngineAnomaly[]

  @@map("User")
}

// User encryption keys for server-side message encryption
model UserKey {
  userId      String   @id @db.NVarChar(36)
  encryptionKey String @db.NVarChar(64) // 32-byte hex key (64 hex chars)
  createdAt   DateTime @default(now())

  @@map("UserKey")
}

model UserPresence {
  id        String   @id @default(uuid()) @db.NVarChar(36)
  userId    String   @unique @db.NVarChar(36)
  isOnline  Boolean  @default(false)
  lastSeenAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isOnline])
  @@map("UserPresence")
}

model MarketplaceListing {
  id            String   @id @default(cuid()) @db.NVarChar(36)
  userId        String   @db.NVarChar(36)
  type          String   @default("FOR_SALE") @db.NVarChar(20) // FOR_SALE, SHARE_SELL, SHARE_WANTED, AIRCRAFT_SALE
  title         String   @db.NVarChar(200)
  description   String?  @db.NVarChar(Max)
  aircraftType  String   @db.NVarChar(100)
  airportIcao   String   @db.NVarChar(10)
  airportName   String?  @db.NVarChar(200)
  airportCity   String?  @db.NVarChar(200)
  latitude      Float?
  longitude     Float?
  price         Int?
  sharePercent  Int?
  hours         Int?
  contactMethod String?  @db.NVarChar(50)
  contactValue  String?  @db.NVarChar(200)
  images        String?  @db.NVarChar(Max)
  status        String   @default("active") @db.NVarChar(20)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Aircraft-specific fields (new)
  nNumber          String?   @db.NVarChar(10)   // N-number (tail number)
  make            String?   @db.NVarChar(100)  // Manufacturer
  model           String?   @db.NVarChar(100)  // Model
  year            Int?                         // Year built
  totalTime       Int?                         // Total time on aircraft (TTSN)
  engineTime      Int?                         // Engine hours
  propTime        Int?                         // Prop hours
  airframeTime    Int?                         // Airframe hours
  annualDue       DateTime?                    // Annual inspection expiration
  registrationType String? @db.NVarChar(50)  // Standard, Limited, Experimental, etc.
  airworthiness  String? @db.NVarChar(50)    // Current, Expired
  fuelType        String? @db.NVarChar(20)   // 100LL, JetA, UL94
  avionics       String? @db.NVarChar(Max)   // JSON array of avionics
  features        String? @db.NVarChar(Max)   // JSON array of features
  upgrades        String? @db.NVarChar(Max)   // JSON array of upgrades
  sellerType      String? @db.NVarChar(20)    // owner, broker, dealer
  isVerified     Boolean  @default(false)     // Verified listing
  verifiedAt     DateTime?                    // When verified
  faaData        String? @db.NVarChar(Max)    // Cached FAA response
  videoUrl        String? @db.NVarChar(500)   // YouTube/video link

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  inquiries AircraftInquiry[]

  @@index([airportIcao], name: "idx_marketplace_airport")
  @@index([type])
  @@index([nNumber])
  @@index([make, model])
  @@index([price])
  @@map("MarketplaceListing")
}

model AircraftInquiry {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  listingId   String   @db.NVarChar(36)
  buyerId     String   @db.NVarChar(36)
  message     String   @db.NVarChar(Max)
  offerAmount Int?                         // If making an offer
  status      String   @default("unread") @db.NVarChar(20) // unread, read, responded, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listing MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User @relation(fields: [buyerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([listingId])
  @@index([buyerId])
  @@index([status])
  @@map("AircraftInquiry")
}

model PilotProfile {
  id           String   @id @default(cuid()) @db.NVarChar(36)
  userId       String   @unique @db.NVarChar(36)
  homeAirport  String?  @db.NVarChar(10)
  homeAirportName String? @db.NVarChar(200)
  homeAirportFbo  String? @db.NVarChar(200)
  homeAirportFuelType String? @db.NVarChar(50)
  ratings      String?  @db.NVarChar(Max)
  availability String?  @db.NVarChar(50)
  aircraft     String?  @db.NVarChar(Max)
  hours        Int?
  bio          String?  @db.NVarChar(Max)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("PilotProfile")
}

model UserContact {
  id         String   @id @default(uuid()) @db.NVarChar(36)
  userId     String   @unique @db.NVarChar(36)
  phone      String?  @db.NVarChar(30)
  address1   String?  @db.NVarChar(255)
  address2   String?  @db.NVarChar(255)
  city       String?  @db.NVarChar(100)
  state      String?  @db.NVarChar(50)
  postalCode String?  @db.NVarChar(20)
  country    String?  @db.NVarChar(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("UserContact")
}

model PilotMedical {
  id               String   @id @default(uuid()) @db.NVarChar(36)
  userId           String   @unique @db.NVarChar(36)
  medicalClass     String?  @db.NVarChar(10)
  certificateNumber String? @db.NVarChar(100)
  examinerName     String?  @db.NVarChar(200)
  issueDate        DateTime?
  expirationDate   DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("PilotMedical")
}

model PilotLicense {
  id        String   @id @default(uuid()) @db.NVarChar(36)
  userId    String   @db.NVarChar(36)
  type      String   @db.NVarChar(100)
  number    String?  @db.NVarChar(100)
  issueDate DateTime?
  ratings   String?  @db.NVarChar(Max)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("PilotLicense")
}

model UserPreferences {
  id               String   @id @default(uuid()) @db.NVarChar(36)
  userId           String   @unique @db.NVarChar(36)
  distanceUnit     String   @default("nautical") @db.NVarChar(20)
  temperatureUnit  String   @default("fahrenheit") @db.NVarChar(20)
  timeFormat       String   @default("24h") @db.NVarChar(10)
  dateFormat       String   @default("MM/DD/YYYY") @db.NVarChar(20)
  mechanicInboxLastViewed DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("UserPreferences")
}

model UserNotificationSettings {
  id                 String   @id @default(uuid()) @db.NVarChar(36)
  userId             String   @unique @db.NVarChar(36)
  maintenanceAlerts  Boolean  @default(true)
  currencyReminders  Boolean  @default(true)
  weatherAlerts      Boolean  @default(false)
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  pushNotifications  Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("UserNotificationSettings")
}

model FriendRequest {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  requesterId String   @db.NVarChar(36)
  recipientId String   @db.NVarChar(36)
  status      String   @default("pending") @db.NVarChar(20) // pending, accepted, declined, cancelled
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Optional encrypted initial message (stored as ciphertext envelope JSON string)
  initialMessageEnvelope String? @db.NVarChar(Max)

  requester User @relation("FriendRequestRequester", fields: [requesterId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  recipient User @relation("FriendRequestRecipient", fields: [recipientId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([requesterId, recipientId])
  @@index([recipientId, status])
  @@index([requesterId, status])
  @@map("FriendRequest")
}

model Conversation {
  id        String   @id @default(uuid()) @db.NVarChar(36)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Marketplace listing this conversation is about (if applicable)
  listingId String?  @db.NVarChar(36)

  participants ConversationParticipant[]
  messages     Message[]

  @@map("Conversation")
}

model ConversationParticipant {
  id             String    @id @default(uuid()) @db.NVarChar(36)
  conversationId String    @db.NVarChar(36)
  userId         String    @db.NVarChar(36)
  lastReadAt     DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("ConversationParticipant")
}

model Message {
  id             String   @id @default(uuid()) @db.NVarChar(36)
  conversationId String   @db.NVarChar(36)
  senderId       String   @db.NVarChar(36)
  body           String   @db.NVarChar(Max)  // Encrypted for recipient
  bodyForSender  String?  @db.NVarChar(Max)  // Encrypted for sender (so they can read their own messages)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("Message")
}

model FlightTrack {
  id     String @id @default(uuid()) @db.NVarChar(36)
  userId String @db.NVarChar(36)

  // Flight Info
  name     String   @db.NVarChar(200)
  date     DateTime
  aircraft String?  @db.NVarChar(100)

  // Track Data (stored as JSON array of points)
  // Each point: { lat: number, lng: number, alt?: number, speed?: number, timestamp: string }
  trackData String @db.NVarChar(Max)

  // Statistics
  totalDistance Float @default(0) // in nautical miles
  maxAltitude   Float @default(0) // in feet
  maxSpeed      Float @default(0) // in knots
  duration      Float @default(0) // in minutes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("FlightTrack")
}

model LogbookEntry {
  id     String @id @default(uuid()) @db.NVarChar(36)
  userId String @db.NVarChar(36)

  // Flight Details
  date      DateTime
  aircraft  String   @db.NVarChar(100)
  routeFrom String   @db.NVarChar(10)
  routeTo   String   @db.NVarChar(10)

  // Times (in hours, use Decimal for precision)
  totalTime        Float @default(0)
  soloTime         Float @default(0)
  dualGiven        Float @default(0)
  dualReceived     Float @default(0)
  nightTime        Float @default(0)
  instrumentTime   Float @default(0)
  crossCountryTime Float @default(0)

  // Landings
  dayLandings   Int @default(0)
  nightLandings Int @default(0)

  // Additional Info
  remarks    String? @db.NVarChar(Max)
  instructor String? @db.NVarChar(100)

  // Link to flight plan if applicable
  flightPlanId String? @db.NVarChar(36)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("LogbookEntry")
}

model TrainingProgress {
  id     String @id @default(uuid()) @db.NVarChar(36)
  userId String @unique @db.NVarChar(36)

  // Hours
  totalHours        Int @default(0)
  soloHours         Int @default(0)
  nightHours        Int @default(0)
  instrumentHours   Int @default(0)
  crossCountryHours Int @default(0)
  xcSoloHours       Int @default(0)
  dualGiven         Int @default(0)
  hoodHours         Int @default(0)

  // Milestones
  xcSoloDone                     Boolean @default(false)
  nightSoloDone                  Boolean @default(false)
  instrumentDone                 Boolean @default(false)
  soloDone                       Boolean @default(false)
  threeTakeoffsLandingsDone      Boolean @default(false)
  threeNightTakeoffsLandingsDone Boolean @default(false)

  lastUpdated DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("TrainingProgress")
}

model TrainingGoal {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  userId      String   @unique @db.NVarChar(36)
  goalType    String   @db.NVarChar(20) // "PPL", "IR", "CPL", "CFI", "CFII", "MEI", "ATP", "HELICOPTER"
  targetDate  DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("TrainingGoal")
}

model TrainingFinancials {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  userId          String   @unique @db.NVarChar(36)
  
  // Cost inputs
  aircraftRate    Decimal  @default(0) @db.Decimal(10, 2)   // $/hr
  instructorRate  Decimal  @default(0) @db.Decimal(10, 2)   // $/hr
  checkrideFee    Decimal  @default(0) @db.Decimal(10, 2)
  examFees        Decimal  @default(0) @db.Decimal(10, 2)
  medicalFee      Decimal  @default(0) @db.Decimal(10, 2)
  monthlyDues     Decimal  @default(0) @db.Decimal(10, 2)
  equipmentCost  Decimal  @default(0) @db.Decimal(10, 2)
  
  // Flight patterns
  flightsPerMonth Int     @default(0)
  avgFlightHours  Decimal @default(0) @db.Decimal(4, 1)  // hours per flight
  
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("TrainingFinancials")
}

// Engine Health Monitoring

model EngineDataUpload {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  aircraftId  String   @db.NVarChar(36)
  userId     String   @db.NVarChar(36)
  uploadDate DateTime @default(now())
  fileName   String   @db.NVarChar(255)
  fileType   String   @db.NVarChar(20) // "JPI", "GARMIN", "AVIDYNE", "EI", "CSV"
  data       String   @db.NVarChar(Max) // JSON encoded flight data
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([aircraftId])
  @@map("EngineDataUpload")
}

model EngineFlightData {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  uploadId        String   @db.NVarChar(36)
  flightDate      DateTime
  flightDuration  Decimal  @db.Decimal(6, 2) // hours
  
  // Cylinder temps (for JPI/EI)
  chtMin          Decimal? @db.Decimal(6, 2)
  chtMax          Decimal? @db.Decimal(6, 2)
  chtAvg          Decimal? @db.Decimal(6, 2)
  egtMin          Decimal? @db.Decimal(6, 2)
  egtMax          Decimal? @db.Decimal(6, 2)
  egtAvg          Decimal? @db.Decimal(6, 2)
  
  // Fuel flow
  fuelFlowMin     Decimal? @db.Decimal(6, 2)
  fuelFlowMax     Decimal? @db.Decimal(6, 2)
  fuelFlowAvg     Decimal? @db.Decimal(6, 2)
  fuelUsed        Decimal? @db.Decimal(8, 2)
  
  // Oil
  oilTempMin      Decimal? @db.Decimal(6, 2)
  oilTempMax      Decimal? @db.Decimal(6, 2)
  oilPressureMin  Decimal? @db.Decimal(6, 2)
  oilPressureMax  Decimal? @db.Decimal(6, 2)
  
  // Other
  rpmAvg          Decimal? @db.Decimal(6, 2)
  manifoldPressure Decimal? @db.Decimal(6, 2)
  
  createdAt       DateTime @default(now())
  
  @@index([uploadId])
  @@index([flightDate])
  @@map("EngineFlightData")
}

model EngineAnomaly {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  aircraftId      String   @db.NVarChar(36)
  userId          String   @db.NVarChar(36)
  uploadId        String?  @db.NVarChar(36)
  flightDate      DateTime
  type            String   @db.NVarChar(30) // "CHT_SPREAD", "EGT_SPREAD", "OIL_TEMP", "OIL_PRESSURE", "FUEL_FLOW"
  severity        String   @db.NVarChar(10) // "INFO", "WARNING", "CRITICAL"
  value           Decimal  @db.Decimal(10, 2)
  threshold       Decimal  @db.Decimal(10, 2)
  message         String   @db.NVarChar(500)
  acknowledged    Boolean  @default(false)
  acknowledgedBy  String?  @db.NVarChar(36)
  acknowledgedAt  DateTime?
  createdAt       DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([aircraftId])
  @@index([severity])
  @@map("EngineAnomaly")
}

model UserAircraft {
  id        String    @id(map: "PK__UserAirc__3213E83F364C6DA2") @default(uuid()) @db.NVarChar(36)
  userId    String    @db.NVarChar(36)
  nNumber   String    @db.NVarChar(10)
  nickname  String?   @db.NVarChar(100)
  notes     String?   @db.NVarChar(Max)
  createdAt DateTime? @default(now(), map: "DF__UserAircr__creat__08B54D69")
  updatedAt DateTime? @default(now(), map: "DF__UserAircr__updat__09A971A2") @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("UserAircraft")
}

model AircraftMaster {
  nNumber        String  @id @map("N_NUMBER") @db.NVarChar(10)
  name           String? @map("NAME") @db.NVarChar(255)
  typeRegistrant String? @map("TYPE_REGISTRANT") @db.NVarChar(50)
  lastActionDate String? @map("LAST_ACTION_DATE") @db.NVarChar(50)
  airWorthDate   String? @map("AIR_WORTH_DATE") @db.NVarChar(50)
  mfr            String? @map("MFR") @db.NVarChar(255)
  model          String? @map("MODEL") @db.NVarChar(255)
  serialNumber   String? @map("SERIAL_NUMBER") @db.NVarChar(255)
  engMfr         String? @map("ENG_MFR") @db.NVarChar(255)
  engineModel    String? @map("ENGINE_MODEL") @db.NVarChar(255)
  engCount       Int?    @map("ENG_COUNT")
  statusCode     String? @map("STATUS_CODE") @db.NVarChar(50)

  @@map("AircraftMaster")
}

model AircraftPerformance {
  id                 Int       @id @default(autoincrement())
  designation        String    @db.VarChar(100)
  manufacturer       String?   @db.VarChar(100)
  model              String?   @db.VarChar(100)
  eis                String?   @db.VarChar(50)
  maxpax             Int?
  pax                Int?
  range_nm           String?   @db.VarChar(50)
  tofl               String?   @db.VarChar(50)
  mrw                String?   @db.VarChar(50)
  mtow               String?   @db.VarChar(50)
  mlw                String?   @db.VarChar(50)
  mzfw               String?   @db.VarChar(50)
  oew                String?   @db.VarChar(50)
  fuel               String?   @db.VarChar(50)
  engine_designation String?   @db.VarChar(100)
  alternate_engines  String?   @db.VarChar(100)
  num_engines        Int?
  thrust_sls         String?   @db.VarChar(50)
  thrust_max         String?   @db.VarChar(50)
  fuel_type          String?   @db.VarChar(50)
  fuel_density       String?   @db.VarChar(50)
  fuel_cap_usable    String?   @db.VarChar(50)
  fuel_cap_unusable  String?   @db.VarChar(50)
  span_ft            String?   @db.VarChar(50)
  length_ft          String?   @db.VarChar(50)
  height_ft          String?   @db.VarChar(50)
  tip_chord          String?   @db.VarChar(50)
  sweep_deg          String?   @db.VarChar(50)
  root_chord         String?   @db.VarChar(50)
  wing_area          String?   @db.VarChar(50)
  wingtip_device     String?   @db.VarChar(50)
  mac                String?   @db.VarChar(50)
  vmo_mo             String?   @db.VarChar(50)
  vc_cruise          String?   @db.VarChar(50)
  v_takeoff          String?   @db.VarChar(50)
  cruise_alt         String?   @db.VarChar(50)
  created_at         DateTime? @default(now(), map: "DF__AircraftP__creat__05D8E0BE") @db.DateTime

  @@map("AircraftPerformance")
}

model AircraftSpecs {
  id                     Int       @id(map: "PK__Aircraft__3213E83F90F6A539") @default(autoincrement())
  manufacturer           String?   @db.NVarChar(100)
  model                  String?   @db.NVarChar(200)
  length_ft              String?   @db.NVarChar(50)
  wingspan_ft            String?   @db.NVarChar(50)
  height_ft              String?   @db.NVarChar(50)
  takeoff_ground_roll_ft String?   @db.NVarChar(50)
  takeoff_over_50ft_ft   String?   @db.NVarChar(50)
  landing_ground_roll_ft String?   @db.NVarChar(50)
  landing_over_50ft_ft   String?   @db.NVarChar(50)
  top_speed_kts          String?   @db.NVarChar(50)
  cruise_speed_kts       String?   @db.NVarChar(50)
  stall_speed_dirty_kts  String?   @db.NVarChar(50)
  stall_speed_clean_kts  String?   @db.NVarChar(50)
  empty_weight_lbs       String?   @db.NVarChar(50)
  gross_weight_lbs       String?   @db.NVarChar(50)
  range_nm               String?   @db.NVarChar(50)
  fuel_capacity_gal      String?   @db.NVarChar(50)
  horsepower             String?   @db.NVarChar(50)
  rate_of_climb_fpm      String?   @db.NVarChar(50)
  service_ceiling_ft     String?   @db.NVarChar(50)
  source_url             String?   @db.NVarChar(500)
  scraped_at             DateTime? @default(now(), map: "DF__AircraftS__scrap__0C85DE4D") @db.DateTime

  @@map("AircraftSpecs")
}

model FlyingGroup {
  id          String    @id(map: "PK__FlyingGr__3213E83F620FD61F") @default("newid()", map: "DF__FlyingGroup__id__160F4887") @db.NVarChar(36)
  name        String    @db.NVarChar(255)
  description String?   @db.NVarChar(Max)
  ownerId     String    @db.NVarChar(36)
  dryRate     Decimal?  @db.Decimal(10, 2)
  wetRate     Decimal?  @db.Decimal(10, 2)
  customRates String?   @db.NVarChar(Max)
  createdAt   DateTime? @default(now(), map: "DF__FlyingGro__creat__17036CC0")
  updatedAt   DateTime? @default(now(), map: "DF__FlyingGro__updat__17F790F9") @updatedAt

  members     GroupMember[]
  memberSettings GroupMemberSettings[]
  invites     Invite[]
  integrations Integration[]

  @@map("FlyingGroup")
}

model GroupMember {
  id       String    @id(map: "PK__GroupMem__3213E83F73ED1832") @default("newid()", map: "DF__GroupMember__id__1BC821DD") @db.NVarChar(36)
  userId   String    @db.NVarChar(36)
  groupId  String    @db.NVarChar(36)
  role     String?   @default("VIEWER", map: "DF__GroupMembe__role__1CBC4616") @db.NVarChar(20)
  joinedAt DateTime? @default(now(), map: "DF__GroupMemb__joine__1DB06A4F")

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("GroupMember")
}

model GroupMemberSettings {
  id                String   @id @default(uuid()) @db.NVarChar(36)
  userId            String   @db.NVarChar(36)
  groupId           String   @db.NVarChar(36)
  defaultTab        String?  @db.NVarChar(50)
  notifyMaintenance Boolean  @default(true)
  notifyBookings    Boolean  @default(true)
  notifyBilling     Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("GroupMemberSettings")
}

model Invite {
  id        String    @id(map: "PK__Invite__3213E83F3215783F") @default("newid()", map: "DF__Invite__id__2180FB33") @db.NVarChar(36)
  groupId   String    @db.NVarChar(36)
  token     String    @unique(map: "UQ__Invite__CA90DA7A533235A9") @db.NVarChar(255)
  email     String?   @db.NVarChar(255)
  role      String?   @default("VIEWER", map: "DF__Invite__role__22751F6C") @db.NVarChar(20)
  expiresAt DateTime
  createdBy String    @db.NVarChar(36)
  createdAt DateTime? @default(now(), map: "DF__Invite__createdA__236943A5")

  group FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("Invite")
}

model Maintenance {
  id              String    @id(map: "PK__Maintena__3213E83FBBF3C62C") @default("newid()", map: "DF__Maintenance__id__3493CFA7") @db.NVarChar(36)
  aircraftId      String    @db.NVarChar(36)
  userId          String    @db.NVarChar(36)
  description     String    @db.NVarChar(Max)
  status          String?   @default("NEEDED", map: "DF__Maintenan__statu__3587F3E0") @db.NVarChar(20)
  maintenanceType String?   @default("CLUB") @db.NVarChar(20) // "PERSONAL" or "CLUB"
  category        String?   @db.NVarChar(50) // Oil, Engine, Avionics, Airframe, Prop, Electrical, Interior, OTHER
  isGeneric       Boolean   @default(false) // True if auto-created squawk
  isPlaneSpecific Boolean  @default(false) // True if goes to admin queue
  severity        String?   @default("LOW") @db.NVarChar(20) // LOW, MEDIUM, HIGH
  flightLogId     String?   @db.NVarChar(36) // Link to flight that caused issue
  reportedByUserId String?  @db.NVarChar(36)
  isGrounded     Boolean   @default(false)
  reportedDate   DateTime? @default(now(), map: "DF__Maintenan__repor__367C1819")
  resolvedDate   DateTime?
  cost           Decimal?  @db.Decimal(10, 2)
  notes          String?   @db.NVarChar(Max)
  createdAt      DateTime? @default(now(), map: "DF__Maintenan__creat__37703C52")
  updatedAt      DateTime? @default(now(), map: "DF__Maintenan__updat__3864608B") @updatedAt

  @@map("Maintenance")
}

model FuelExpense {
  id           String    @id @default("newid()") @db.NVarChar(36)
  aircraftId   String    @db.NVarChar(36)
  userId       String    @db.NVarChar(36)
  flightLogId  String?   @db.NVarChar(36)
  gallons      Decimal   @db.Decimal(10, 2)
  pricePerGallon Decimal @db.Decimal(10, 2)
  totalCost    Decimal   @db.Decimal(10, 2)
  status       String    @default("PENDING") @db.NVarChar(20) // PENDING, APPROVED, DENIED
  receiptUrl   String?   @db.NVarChar(500)
  notes        String?   @db.NVarChar(Max)
  approvedBy   String?   @db.NVarChar(36)
  approvedAt   DateTime?
  createdAt    DateTime? @default(now())
  updatedAt    DateTime? @default(now()) @updatedAt

  @@map("FuelExpense")
}

model ClubAircraft {
  id               String    @id(map: "PK__ClubAirc__3213E83F197A971B") @default("newid()", map: "DF__ClubAircraft__id__2645B050") @db.NVarChar(36)
  groupId          String    @db.NVarChar(36)
  nNumber          String?   @db.NVarChar(10)
  nickname         String?   @db.NVarChar(100)
  customName       String?   @db.NVarChar(255)
  hourlyRate       Decimal?  @db.Decimal(10, 2)
  createdAt        DateTime? @default(now(), map: "DF__ClubAircr__creat__2739D489")
  updatedAt        DateTime? @default(now(), map: "DF__ClubAircr__updat__282DF8C2") @updatedAt
  make             String?   @db.NVarChar(100)
  model            String?   @db.NVarChar(100)
  year             Int?
  totalTachHours   Decimal?  @db.Decimal(6, 2)
  totalHobbsHours  Decimal?  @db.Decimal(6, 2)
  registrationType String?   @db.NVarChar(50)
  hasInsurance     Boolean?
  maxPassengers    Int?
  aircraftNotes    String?   @db.NVarChar(Max)
  status           String?   @db.NVarChar(50)
  bookingWindowDays Int     @default(30)

  @@map("ClubAircraft")
}

model Booking {
  id         String    @id(map: "PK__Booking__3213E83F64A346D6") @default("newid()", map: "DF__Booking__id__2B0A656D") @db.NVarChar(36)
  aircraftId String    @db.NVarChar(36)
  userId     String    @db.NVarChar(36)
  startTime  DateTime
  endTime    DateTime
  purpose    String?   @db.NVarChar(500)
  createdAt  DateTime? @default(now(), map: "DF__Booking__created__2BFE89A6")
  updatedAt  DateTime? @default(now(), map: "DF__Booking__updated__2CF2ADDF") @updatedAt

  @@map("Booking")
}

model PersonalBooking {
  id             String    @id(map: "PK__PersonalBooking__3213E83F") @default("newid()") @db.NVarChar(36)
  userId         String    @db.NVarChar(36)
  userAircraftId String    @db.NVarChar(36)
  startTime      DateTime
  endTime        DateTime
  purpose        String?   @db.NVarChar(500)
  createdAt      DateTime? @default(now())
  updatedAt      DateTime? @updatedAt

  @@index([userId])
  @@index([userAircraftId])
  @@map("PersonalBooking")
}

model GroupChatMessage {
  id        String   @id @default(uuid()) @db.NVarChar(36)
  groupId   String   @db.NVarChar(36)
  userId    String   @db.NVarChar(36)
  message   String   @db.NVarChar(1000)
  createdAt DateTime @default(now())

  @@index([groupId, createdAt])
  @@index([userId])
  @@map("GroupChatMessage")
}

model FlightLog {
  id             String    @id(map: "PK__FlightLo__3213E83FB28F28FC") @default("newid()", map: "DF__FlightLog__id__2FCF1A8A") @db.NVarChar(36)
  aircraftId     String    @db.NVarChar(36)
  userId         String    @db.NVarChar(36)
  date           DateTime
  tachTime       Decimal?  @db.Decimal(6, 2)
  hobbsTime      Decimal?  @db.Decimal(6, 2)
  calculatedCost Decimal?  @db.Decimal(10, 2)
  notes          String?   @db.NVarChar(Max)
  createdAt      DateTime? @default(now(), map: "DF__FlightLog__creat__30C33EC3")
  updatedAt      DateTime? @default(now(), map: "DF__FlightLog__updat__31B762FC") @updatedAt
  hobbsStart     Decimal?  @db.Decimal(6, 2)
  hobbsEnd       Decimal?  @db.Decimal(6, 2)

  @@map("FlightLog")
}

model FlightPlan {
  id            String    @id @default(uuid()) @db.NVarChar(36)
  userId        String    @db.NVarChar(36)
  name          String?   @db.NVarChar(255)
  callsign      String?   @db.NVarChar(20)
  aircraftType  String?   @db.NVarChar(20)
  aircraftSpeed Int?
  aircraftBurnRate Float?
  aircraftFuelCapacity Int?
  pilotName     String?   @db.NVarChar(100)
  departureIcao String?   @db.NVarChar(10)
  departureTime DateTime?
  departureFuel Int?
  arrivalIcao   String?   @db.NVarChar(10)
  alternateIcao String?   @db.NVarChar(10)
  cruisingAlt   Int?
  route         String?   @db.NVarChar(Max)
  remarks       String?   @db.NVarChar(Max)
  soulsOnBoard  Int?
  isFiled       Boolean   @default(false)
  filedAt       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  waypoints FlightPlanWaypoint[]
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("FlightPlan")
}

model FlightPlanWaypoint {
  id           String   @id @default(uuid())
  flightPlanId String   @db.NVarChar(36)
  sequence     Int
  icao         String?  @db.NVarChar(10)
  name         String?  @db.NVarChar(100)
  city         String?  @db.NVarChar(100)
  waypointId   String?  @db.NVarChar(20)
  latitude     Float
  longitude    Float
  altitude     Int?
  flightType   String?  @db.NVarChar(10)
  createdAt    DateTime @default(now())

  flightPlan FlightPlan @relation(fields: [flightPlanId], references: [id], onDelete: Cascade)

  @@map("FlightPlanWaypoint")
}

// ============ CACHE TABLES ============

model AirportCache {
  icao         String   @id @db.NVarChar(10)
  iata         String?  @db.NVarChar(3)
  name         String   @db.NVarChar(255)
  city         String?  @db.NVarChar(100)
  state        String?  @db.NVarChar(50)
  country      String?  @db.NVarChar(100)
  latitude     Float
  longitude    Float
  elevation_ft Int?
  type         String   @db.NVarChar(50) // large_airport, medium_airport, small_airport, seaplane_base, heliport
  timezone     String?  @db.NVarChar(50)
  hasTower     Boolean?
  hasWeather   Boolean?
  scraped_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([type])
  @@index([country, state])
  @@map("AirportCache")
}

model FuelPriceCache {
  icao          String    @id @db.NVarChar(10)
  price100ll    Decimal?  @db.Decimal(6, 2)
  priceJetA     Decimal?  @db.Decimal(6, 2)
  priceSulfar   Decimal?  @db.Decimal(6, 2) // UL94
  source        String?   @db.NVarChar(50) // airnav, fuel100, own
  source_url    String?   @db.NVarChar(500)
  last_reported DateTime?
  attribution   String?   @db.NVarChar(255)
  scraped_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@index([price100ll])
  @@map("FuelPriceCache")
}

// Community-reported fuel prices (layered on top of AirNav data)
model CommunityFuelPrice {
  id            String   @id @default(uuid()) @db.NVarChar(36)
  icao          String   @db.NVarChar(10)
  fbo           String?  @db.NVarChar(100)
  fuelType      String   @db.NVarChar(10) // 100LL, JetA
  price         Decimal  @db.Decimal(6, 2)
  purchaseDate  DateTime
  userId        String?  @db.NVarChar(36) // Optional - can be anonymous
  createdAt     DateTime @default(now())

  @@index([icao, fuelType])
  @@index([purchaseDate])
  @@map("CommunityFuelPrice")
}

model AircraftCache {
  id           Int     @id @default(autoincrement())
  manufacturer String  @db.NVarChar(100)
  model        String  @db.NVarChar(200)
  year         Int?
  variant      String? @db.NVarChar(100)

  // Engine specs
  engine_type             String?  @db.NVarChar(50) // Piston, Turbine, Jet
  engine_count            Int?
  fuel_type               String?  @db.NVarChar(50) // 100LL, JetA, UL94, Mogas
  fuel_capacity_gal       Decimal? @db.Decimal(8, 2)
  fuel_capacityusable_gal Decimal? @db.Decimal(8, 2)

  // Performance - fuel saver relevant
  cruise_speed_kts      Int? // Typical cruise speed
  burn_rate_gph         Decimal? @db.Decimal(6, 2) // gallons per hour
  range_nm              Int? // Range with full tanks
  range_with_reserve_nm Int? // Range with reserves (45min + 1hr)

  // Weights
  empty_weight_lbs       Int?
  max_takeoff_weight_lbs Int?
  max_landing_weight_lbs Int?

  // Useful for planning
  pax_capacity    Int?
  useful_load_lbs Int?

  // Source
  source_url  String?  @db.NVarChar(500)
  is_verified Boolean  @default(false)
  scraped_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([manufacturer, model])
  @@index([fuel_type])
  @@map("AircraftCache")
}

model WeatherCache {
  icao         String   @id @db.NVarChar(10)
  station_type String?  @db.NVarChar(20) // METAR, TAF
  raw_data     String   @db.NVarChar(Max)
  parsed_data  String?  @db.NVarChar(Max) // JSON parsed
  valid_from   DateTime
  valid_until  DateTime
  scraped_at   DateTime @default(now())

  @@index([valid_until])
  @@map("WeatherCache")
}

model Document {
  id          String    @id @default(uuid()) @db.NVarChar(36)
  userId      String    @db.NVarChar(36)
  name        String    @db.NVarChar(255)
  type        String    @db.NVarChar(50) // POH, insurance, registration, maintenance, other
  fileUrl     String    @db.NVarChar(500)
  fileSize    Int?
  mimeType    String?   @db.NVarChar(100)
  description String?   @db.NVarChar(500)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Document")
}

model ErrorReport {
  id               String   @id @default(uuid()) @db.NVarChar(36)
  userId           String?  @db.NVarChar(36)
  email            String?  @db.NVarChar(255)
  title            String   @db.NVarChar(255)
  description      String   @db.NVarChar(Max)
  stepsToReproduce String?  @db.NVarChar(Max)
  url              String?  @db.NVarChar(500)
  browser          String?  @db.NVarChar(100)
  status           String   @default("open") @db.NVarChar(20)
  resolution       String?  @db.NVarChar(Max)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ErrorReport")
}

model BlockOut {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  groupId     String   @db.NVarChar(36)
  aircraftId  String?  @db.NVarChar(36)
  title       String   @db.NVarChar(255)
  startTime   DateTime
  endTime     DateTime
  createdAt   DateTime @default(now())

  @@map("BlockOut")
}

model BillingRun {
  id           String    @id @default(uuid()) @db.NVarChar(36)
  groupId      String    @db.NVarChar(36)
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  status       String    @db.NVarChar(20) // "running", "completed", "failed"
  totalAmount  Decimal?  @db.Decimal(10, 2)
  successCount Int?
  failureCount Int?
  details      String?   @db.NVarChar(Max) // JSON with per-member results

  @@map("BillingRun")
}

model Invoice {
  id              String    @id @default(uuid()) @db.NVarChar(36)
  groupId         String    @db.NVarChar(36)
  userId          String    @db.NVarChar(36)
  billingRunId    String    @db.NVarChar(36)
  totalAmount     Decimal   @db.Decimal(10, 2)
  status          String    @default("pending") @db.NVarChar(20) // "pending", "paid", "failed"
  stripePaymentId String?   @db.NVarChar(100)
  pdfUrl          String?   @db.NVarChar(500)
  sentAt          DateTime?
  createdAt       DateTime  @default(now())

  items InvoiceItem[]

  @@map("Invoice")
}

model InvoiceItem {
  id          String  @id @default(uuid()) @db.NVarChar(36)
  invoiceId   String  @db.NVarChar(36)
  flightLogId String  @db.NVarChar(36)
  aircraftId  String  @db.NVarChar(36)
  hobbsHours  Decimal @db.Decimal(6, 2)
  hourlyRate  Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("InvoiceItem")
}

// Demo data configuration - controls what sample data gets generated
model DemoData {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  key         String   @unique @db.NVarChar(50)  // e.g., "clubs", "aircraft", "members", "bookings"
  enabled     Boolean  @default(true)
  config      String?  @db.NVarChar(Max) // JSON config for this data type
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("DemoData")
}

// ============ OUTREACH SYSTEM ============

model OutreachContact {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  
  // Organization info
  organizationType String  @db.NVarChar(50) // "airport", "flight_club", "flight_school", "fbo"
  organizationName String  @db.NVarChar(255)
  airportIcao      String? @db.NVarChar(10)
  airportName      String? @db.NVarChar(255)
  city             String? @db.NVarChar(100)
  state            String? @db.NVarChar(50)
  
  // Contact person info
  contactName      String? @db.NVarChar(255)
  contactTitle     String? @db.NVarChar(100) // "President", "Treasurer", "Manager", "Owner"
  contactEmail     String? @db.NVarChar(255)
  contactPhone     String? @db.NVarChar(50)
  alternateEmail   String? @db.NVarChar(255)
  alternatePhone   String? @db.NVarChar(50)
  
  // Source tracking
  sourceUrl        String? @db.NVarChar(500)
  sourceType       String  @db.NVarChar(50) // "airnav", "aopa", "eaa", "manual", "import"
  scrapedAt        DateTime @default(now())
  
  // Additional data
  website          String? @db.NVarChar(500)
  notes            String? @db.NVarChar(Max)
  
  // Relations
  emails          OutreachEmail[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationType])
  @@index([state])
  @@index([airportIcao])
  @@index([contactEmail])
  @@map("OutreachContact")
}

model OutreachCampaign {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  name        String   @db.NVarChar(255)
  description String?  @db.NVarChar(Max)
  subject     String   @db.NVarChar(500)
  bodyHtml    String   @db.NVarChar(Max)
  bodyText    String?  @db.NVarChar(Max)
  
  status      String   @default("draft") @db.NVarChar(20) // draft, active, paused, completed
  
  // Stats
  totalContacts Int     @default(0)
  emailsSent    Int     @default(0)
  emailsOpened  Int     @default(0)
  emailsClicked Int     @default(0)
  responses     Int     @default(0)
  interested    Int     @default(0)
  
  emails      OutreachEmail[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  @@map("OutreachCampaign")
}

model OutreachEmail {
  id           String   @id @default(uuid()) @db.NVarChar(36)
  campaignId   String   @db.NVarChar(36)
  contactId    String   @db.NVarChar(36)
  
  // Email details
  toEmail      String   @db.NVarChar(255)
  toName       String?  @db.NVarChar(255)
  subject      String   @db.NVarChar(500)
  bodyHtml     String   @db.NVarChar(Max)
  bodyText     String?  @db.NVarChar(Max)
  
  // Delivery tracking
  status       String   @default("pending") @db.NVarChar(20) // pending, sent, delivered, failed, bounced
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  
  // Response tracking (manual)
  responseStatus String? @db.NVarChar(20) // null, "responded", "interested", "not_interested", "invalid"
  responseNotes  String? @db.NVarChar(Max)
  respondedAt    DateTime?
  
  // External IDs
  resendId       String? @db.NVarChar(100)
  
  // Relations
  campaign    OutreachCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact     OutreachContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([responseStatus])
  @@map("OutreachEmail")
}

// ────────────────────────────────────────────────────────────────────────────
// QuickBooks Integration Models
// ────────────────────────────────────────────────────────────────────────────

model Integration {
  id               String    @id @default(uuid()) @db.NVarChar(36)
  groupId          String    @db.NVarChar(36) // Flying club this integration belongs to
  provider         String    @db.NVarChar(50) // "quickbooks", "google-calendar", "zapier"
  status           String    @default("disconnected") @db.NVarChar(20) // "connected", "disconnected", "error"
  
  // OAuth tokens (encrypted in production)
  accessToken      String?   @db.NVarChar(Max)
  refreshToken     String?   @db.NVarChar(Max)
  tokenExpiry      DateTime?
  realmId          String?   @db.NVarChar(100) // QuickBooks Company ID
  
  // Configuration
  config           String    @default("{}") @db.NVarChar(Max) // JSON config
  
  // Metadata
  lastSyncAt       DateTime?
  lastSyncStatus   String?   @db.NVarChar(20) // "success", "error", "partial"
  lastSyncError    String?   @db.NVarChar(Max)
  syncFrequency    Int       @default(10) // minutes
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  group            FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  mappings         QuickBooksMapping[]
  syncLogs         SyncLog[]

  @@unique([groupId, provider])
  @@index([groupId])
  @@index([provider])
  @@index([status])
  @@map("Integration")
}

model QuickBooksMapping {
  id                String   @id @default(uuid()) @db.NVarChar(36)
  integrationId     String   @db.NVarChar(36)
  
  // Local entity (what we're mapping FROM)
  entityType        String   @db.NVarChar(50) // "aircraft", "rate", "member", "charge_type"
  entityId          String   @db.NVarChar(36)
  entityName        String   @db.NVarChar(255) // Human-readable name
  
  // QuickBooks entity (what we're mapping TO)
  qbType            String   @db.NVarChar(50) // "Item", "Customer", "Account", "Class"
  qbId              String   @db.NVarChar(100) // QuickBooks ID
  qbName            String   @db.NVarChar(255) // QuickBooks name
  
  // Mapping config
  config            String   @default("{}") @db.NVarChar(Max) // JSON for special rules
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  integration       Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, entityType, entityId])
  @@index([integrationId])
  @@index([entityType, entityId])
  @@map("QuickBooksMapping")
}

model SyncLog {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  integrationId   String   @db.NVarChar(36)
  
  // What was synced
  syncType        String   @db.NVarChar(50) // "invoice", "payment", "customer", "manual", "scheduled"
  direction       String   @db.NVarChar(20) // "to_qb", "from_qb", "bidirectional"
  
  // Results
  status          String   @db.NVarChar(20) // "success", "error", "partial"
  recordsTotal    Int      @default(0)
  recordsSuccess  Int      @default(0)
  recordsFailed   Int      @default(0)
  
  // Details
  details         String?  @db.NVarChar(Max) // JSON with specifics
  errorMessage    String?  @db.NVarChar(Max)
  
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  durationMs      Int?     // Duration in milliseconds
  
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([syncType])
  @@index([status])
  @@index([startedAt])
  @@map("SyncLog")
}

// Flying Club Currency Tracking - FAA Standard Currency Rules

model PilotCurrency {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  userId          String   @db.NVarChar(36)
  groupId         String   @db.NVarChar(36)
  
  // Day currency (3 takeoffs/landings in last 90 days)
  dayLandings     Int      @default(0)
  dayLandingsDate DateTime?
  
  // Night currency (3 takeoffs/landings in last 90 days)  
  nightLandings   Int      @default(0)
  nightLandingsDate DateTime?
  
  // Instrument currency (6 approaches, holds, intercepting in last 6 months)
  approaches     Int      @default(0)
  holds          Int      @default(0)
  instrumentTime Decimal  @default(0) @db.Decimal(8, 2)
  instrumentCurrencyDate DateTime?
  
  // Tail-specific currency (aircraft user is cleared for) - stored as JSON
  clearedAircraft String   @default("[]") @db.NVarChar(Max)
  
  // Meta
  lastFlightDate  DateTime?
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("PilotCurrency")
}

model NotificationPreference {
  id            String   @id @default(uuid()) @db.NVarChar(36)
  userId        String   @db.NVarChar(36)
  groupId       String?  @db.NVarChar(36)  // null = global preferences
  
  // Email notifications
  emailBookingConfirm Boolean @default(true)
  emailBookingReminder Boolean @default(true)
  emailMaintenanceAlert Boolean @default(true)
  emailBillingRun    Boolean @default(true)
  emailCurrencyExpiry Boolean @default(true)
  
  // SMS notifications (if enabled)
  smsBookingConfirm Boolean @default(false)
  smsBookingReminder Boolean @default(false)
  smsMaintenanceAlert Boolean @default(false)
  smsUrgent         Boolean @default(true)
  
  // Phone for SMS
  phone           String?  @db.NVarChar(20)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, groupId])
  @@index([userId])
  @@map("NotificationPreference")
}

// ============ MECHANIC MARKETPLACE ============

model Mechanic {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  userId          String   @unique @db.NVarChar(36)
  
  // Contact info
  email           String   @unique @db.NVarChar(255)
  name            String   @db.NVarChar(255)
  phone           String?  @db.NVarChar(50)
  
  // Business info
  businessName    String?  @db.NVarChar(255)
  city            String?  @db.NVarChar(100)
  state           String?  @db.NVarChar(50)
  locationIcao    String?  @db.NVarChar(10)
  locationLat     Float?
  locationLng     Float?
  locationPrivacy String   @default("CITY") @db.NVarChar(20) // CITY, ICAO
  serviceRadiusNm Int?
  serviceArea     String?  @db.NVarChar(500) // Areas they service (comma-separated)
  
  // Specialties (JSON array)
  specialties     String?  @db.NVarChar(Max) // e.g., ["piston", "turbine", "avionics"]
  
  // Bio
  bio             String?  @db.NVarChar(Max)
  yearsExperience Int?     @default(0)
  
  // Certification
  certifications  String?  @db.NVarChar(Max) // JSON array of certs
  certificateNumber String? @db.NVarChar(100)
  iaNumber        String?  @db.NVarChar(100) // Inspection Authorization
  a_pLicense      String?  @db.NVarChar(50)  // A&P license number
  expiryDate      DateTime? // Certificate expiry
  
  // Rating
  rating          Decimal  @default(0) @db.Decimal(3, 2)
  reviewCount     Int      @default(0)
  
  // Status
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  // Pricing
  hourlyRate      Decimal? @db.Decimal(10, 2)
  travelFee       Decimal? @db.Decimal(10, 2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  quotes          MechanicQuote[]
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([city, state])
  @@index([locationIcao])
  @@index([isActive])
  @@map("Mechanic")
}

// Public maintenance requests (shown in marketplace)
model MaintenanceRequest {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  postedByUserId  String?  @db.NVarChar(36)
  
  // Reference to internal maintenance if from club
  maintenanceId   String?  @db.NVarChar(36)
  groupId         String?  @db.NVarChar(36)
  aircraftId      String?  @db.NVarChar(36)
  
  // Public info
  title           String   @db.NVarChar(255)
  description     String   @db.NVarChar(Max)
  aircraftType    String?  @db.NVarChar(100) // e.g., "Cessna 172", "Piper Cherokee"
  nNumber         String?  @db.NVarChar(10)
  
  // Location
  airportIcao     String?  @db.NVarChar(10)
  airportName     String?  @db.NVarChar(255)
  city            String?  @db.NVarChar(100)
  state           String?  @db.NVarChar(50)
  locationLat     Float?
  locationLng     Float?
  locationPrivacy String   @default("CITY") @db.NVarChar(20) // CITY, ICAO
  
  // Category
  category        String   @db.NVarChar(50) // Engine, Avionics, Airframe, Oil, Prop, Electrical, OTHER
  urgency         String   @default("NORMAL") @db.NVarChar(20) // LOW, NORMAL, HIGH, URGENT
  neededBy        DateTime?
  jobSize         String   @default("MEDIUM") @db.NVarChar(20) // SMALL, MEDIUM, LARGE
  
  // Budget
  budgetMin       Decimal? @db.Decimal(10, 2)
  budgetMax       Decimal? @db.Decimal(10, 2)
  
  // Status
  status          String   @default("OPEN") @db.NVarChar(20) // OPEN, QUOTED, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED, REVOKED
  source          String   @default("manual") @db.NVarChar(20) // squawk, manual, scheduled
  anonymous       Boolean  @default(true)
  requestedWork   String?  @db.NVarChar(Max)
  visibility      String   @default("MECHANIC") @db.NVarChar(20) // MECHANIC, PUBLIC
  
  // User info (who posted)
  postedByName    String?  @db.NVarChar(255)
  postedByEmail   String?  @db.NVarChar(255)
  postedByPhone   String?  @db.NVarChar(50)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  quotes          MechanicQuote[]
  postedBy        User?             @relation("UserMaintenanceRequests", fields: [postedByUserId], references: [id], onDelete: SetNull)
  
  @@index([category])
  @@index([status])
  @@index([jobSize])
  @@index([city, state])
  @@index([airportIcao])
  @@map("MaintenanceRequest")
}

// Quotes from mechanics on maintenance requests
model MechanicQuote {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  
  // References
  maintenanceRequestId String @db.NVarChar(36)
  mechanicId      String   @db.NVarChar(36)
  
  // Quote details
  amount          Decimal? @db.Decimal(10, 2)
  description     String   @db.NVarChar(Max)
  laborRate       Decimal? @db.Decimal(10, 2)
  laborHours      Decimal? @db.Decimal(10, 2)
  partsEstimate   Decimal? @db.Decimal(10, 2)
  requiresApproval Boolean @default(false)
  
  // Timeline
  estimatedDays   Int?     // Days to complete
  availableDate   DateTime? // When they can start
  
  // Contact
  contactMethod   String?  @db.NVarChar(50) // email, phone, both
  notes           String?  @db.NVarChar(Max)
  
  // Status
  status          String   @default("PENDING") @db.NVarChar(20) // PENDING, ACCEPTED, DECLINED, WITHDRAWN
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  maintenanceRequest MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  mechanic          Mechanic            @relation(fields: [mechanicId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  @@index([maintenanceRequestId])
  @@index([mechanicId])
  @@index([status])
  @@map("MechanicQuote")
}

model MechanicJobSchedule {
  id              String   @id @default(uuid()) @db.NVarChar(36)
  maintenanceRequestId String @db.NVarChar(36)
  mechanicQuoteId String @db.NVarChar(36)
  scheduledFor    DateTime
  estimatedHours  Decimal? @db.Decimal(6, 2)
  location        String?  @db.NVarChar(255)
  notes           String?  @db.NVarChar(Max)
  status          String   @default("SCHEDULED") @db.NVarChar(20) // SCHEDULED, COMPLETED, CANCELLED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  maintenanceRequest MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  mechanicQuote       MechanicQuote      @relation(fields: [mechanicQuoteId], references: [id], onDelete: Cascade)

  @@index([maintenanceRequestId])
  @@index([mechanicQuoteId])
  @@index([status])
  @@map("MechanicJobSchedule")
}

model MechanicReview {
  id           String   @id @default(uuid()) @db.NVarChar(36)
  mechanicId   String   @db.NVarChar(36)
  reviewerId   String   @db.NVarChar(36)
  maintenanceRequestId String @db.NVarChar(36)
  rating       Int      @db.Int
  comment      String?  @db.NVarChar(Max)
  createdAt    DateTime @default(now())

  mechanic     Mechanic            @relation(fields: [mechanicId], references: [id], onDelete: Cascade)
  maintenanceRequest MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)

  @@index([mechanicId])
  @@index([maintenanceRequestId])
  @@map("MechanicReview")
}
