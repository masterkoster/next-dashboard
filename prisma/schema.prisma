generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(uuid())
  username         String    @unique @db.NVarChar(50)
  email            String    @unique @db.NVarChar(255)
  name             String?   @db.NVarChar(255)
  purchasedModules String    @default("[]") @db.NVarChar(Max)
  credits          Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  password         String?   @db.NVarChar(255)
  
  // Email verification
  emailVerified    DateTime?
  verifyToken      String?   @db.NVarChar(255)
  verifyTokenExpiry DateTime?
  
  // Password reset
  resetToken       String?   @db.NVarChar(255)
  resetTokenExpiry DateTime?
  
  // Role for admin access
  role            String   @default("user") @db.NVarChar(20) // user, admin, owner
  
  // Subscription fields
  tier              String   @default("free") @db.NVarChar(20) // free, pro
  stripeCustomerId  String?  @db.NVarChar(100)
  stripeSubscriptionId String? @db.NVarChar(100)
  subscriptionEnd   DateTime?
  homeState         String?  @db.NVarChar(2) // User's home state for fuel tracking
  
  flightPlans      FlightPlan[]
  memberships      GroupMember[]
  aircraft         UserAircraft[]
  documents        Document[]
  errorReports     ErrorReport[]
  trainingProgress TrainingProgress?
  logbookEntries   LogbookEntry[]
  flightTracks     FlightTrack[]

  @@map("User")
}

model FlightTrack {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  userId      String   @db.NVarChar(36)
  
  // Flight Info
  name        String   @db.NVarChar(200)
  date        DateTime
  aircraft    String?  @db.NVarChar(100)
  
  // Track Data (stored as JSON array of points)
  // Each point: { lat: number, lng: number, alt?: number, speed?: number, timestamp: string }
  trackData   String   @db.NVarChar(Max)
  
  // Statistics
  totalDistance Float  @default(0) // in nautical miles
  maxAltitude   Float  @default(0) // in feet
  maxSpeed      Float  @default(0) // in knots
  duration      Float  @default(0) // in minutes
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("FlightTrack")
}

model LogbookEntry {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  userId      String   @db.NVarChar(36)
  
  // Flight Details
  date        DateTime
  aircraft    String   @db.NVarChar(100)
  routeFrom   String   @db.NVarChar(10)
  routeTo     String   @db.NVarChar(10)
  
  // Times (in hours, use Decimal for precision)
  totalTime   Float    @default(0)
  soloTime    Float    @default(0)
  dualGiven   Float    @default(0)
  dualReceived Float   @default(0)
  nightTime   Float    @default(0)
  instrumentTime Float @default(0)
  crossCountryTime Float @default(0)
  
  // Landings
  dayLandings  Int     @default(0)
  nightLandings Int    @default(0)
  
  // Additional Info
  remarks     String?  @db.NVarChar(Max)
  instructor  String?  @db.NVarChar(100)
  
  // Link to flight plan if applicable
  flightPlanId String? @db.NVarChar(36)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("LogbookEntry")
}

model TrainingProgress {
  id        String   @id @default(uuid()) @db.NVarChar(36)
  userId    String   @unique @db.NVarChar(36)
  
  // Hours
  totalHours          Int      @default(0)
  soloHours            Int      @default(0)
  nightHours           Int      @default(0)
  instrumentHours      Int      @default(0)
  crossCountryHours    Int      @default(0)
  xcSoloHours          Int      @default(0)
  dualGiven            Int      @default(0)
  hoodHours            Int      @default(0)
  
  // Milestones
  xcSoloDone                       Boolean @default(false)
  nightSoloDone                    Boolean @default(false)
  instrumentDone                   Boolean @default(false)
  soloDone                         Boolean @default(false)
  threeTakeoffsLandingsDone        Boolean @default(false)
  threeNightTakeoffsLandingsDone   Boolean @default(false)
  
  lastUpdated DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("TrainingProgress")
}

model UserAircraft {
  id        String    @id(map: "PK__UserAirc__3213E83F364C6DA2") @default(uuid()) @db.NVarChar(36)
  userId    String    @db.NVarChar(36)
  nNumber   String    @db.NVarChar(10)
  nickname  String?   @db.NVarChar(100)
  notes     String?   @db.NVarChar(Max)
  createdAt DateTime? @default(now(), map: "DF__UserAircr__creat__08B54D69")
  updatedAt DateTime? @default(now(), map: "DF__UserAircr__updat__09A971A2") @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("UserAircraft")
}

model AircraftMaster {
  nNumber        String  @id @map("N_NUMBER") @db.NVarChar(10)
  name           String? @map("NAME") @db.NVarChar(255)
  typeRegistrant String? @map("TYPE_REGISTRANT") @db.NVarChar(50)
  lastActionDate String? @map("LAST_ACTION_DATE") @db.NVarChar(50)
  airWorthDate   String? @map("AIR_WORTH_DATE") @db.NVarChar(50)
  mfr            String? @map("MFR") @db.NVarChar(255)
  model          String? @map("MODEL") @db.NVarChar(255)
  serialNumber   String? @map("SERIAL_NUMBER") @db.NVarChar(255)
  engMfr         String? @map("ENG_MFR") @db.NVarChar(255)
  engineModel    String? @map("ENGINE_MODEL") @db.NVarChar(255)
  engCount       Int?    @map("ENG_COUNT")
  statusCode     String? @map("STATUS_CODE") @db.NVarChar(50)

  @@map("AircraftMaster")
}

model AircraftPerformance {
  id                 Int       @id @default(autoincrement())
  designation        String    @db.VarChar(100)
  manufacturer       String?   @db.VarChar(100)
  model              String?   @db.VarChar(100)
  eis                String?   @db.VarChar(50)
  maxpax             Int?
  pax                Int?
  range_nm           String?   @db.VarChar(50)
  tofl               String?   @db.VarChar(50)
  mrw                String?   @db.VarChar(50)
  mtow               String?   @db.VarChar(50)
  mlw                String?   @db.VarChar(50)
  mzfw               String?   @db.VarChar(50)
  oew                String?   @db.VarChar(50)
  fuel               String?   @db.VarChar(50)
  engine_designation String?   @db.VarChar(100)
  alternate_engines  String?   @db.VarChar(100)
  num_engines        Int?
  thrust_sls         String?   @db.VarChar(50)
  thrust_max         String?   @db.VarChar(50)
  fuel_type          String?   @db.VarChar(50)
  fuel_density       String?   @db.VarChar(50)
  fuel_cap_usable    String?   @db.VarChar(50)
  fuel_cap_unusable  String?   @db.VarChar(50)
  span_ft            String?   @db.VarChar(50)
  length_ft          String?   @db.VarChar(50)
  height_ft          String?   @db.VarChar(50)
  tip_chord          String?   @db.VarChar(50)
  sweep_deg          String?   @db.VarChar(50)
  root_chord         String?   @db.VarChar(50)
  wing_area          String?   @db.VarChar(50)
  wingtip_device     String?   @db.VarChar(50)
  mac                String?   @db.VarChar(50)
  vmo_mo             String?   @db.VarChar(50)
  vc_cruise          String?   @db.VarChar(50)
  v_takeoff          String?   @db.VarChar(50)
  cruise_alt         String?   @db.VarChar(50)
  created_at         DateTime? @default(now(), map: "DF__AircraftP__creat__05D8E0BE") @db.DateTime

  @@map("AircraftPerformance")
}

model AircraftSpecs {
  id                     Int       @id(map: "PK__Aircraft__3213E83F90F6A539") @default(autoincrement())
  manufacturer           String?   @db.NVarChar(100)
  model                  String?   @db.NVarChar(200)
  length_ft              String?   @db.NVarChar(50)
  wingspan_ft            String?   @db.NVarChar(50)
  height_ft              String?   @db.NVarChar(50)
  takeoff_ground_roll_ft String?   @db.NVarChar(50)
  takeoff_over_50ft_ft   String?   @db.NVarChar(50)
  landing_ground_roll_ft String?   @db.NVarChar(50)
  landing_over_50ft_ft   String?   @db.NVarChar(50)
  top_speed_kts          String?   @db.NVarChar(50)
  cruise_speed_kts       String?   @db.NVarChar(50)
  stall_speed_dirty_kts  String?   @db.NVarChar(50)
  stall_speed_clean_kts  String?   @db.NVarChar(50)
  empty_weight_lbs       String?   @db.NVarChar(50)
  gross_weight_lbs       String?   @db.NVarChar(50)
  range_nm               String?   @db.NVarChar(50)
  fuel_capacity_gal      String?   @db.NVarChar(50)
  horsepower             String?   @db.NVarChar(50)
  rate_of_climb_fpm      String?   @db.NVarChar(50)
  service_ceiling_ft     String?   @db.NVarChar(50)
  source_url             String?   @db.NVarChar(500)
  scraped_at             DateTime? @default(now(), map: "DF__AircraftS__scrap__0C85DE4D") @db.DateTime

  @@map("AircraftSpecs")
}

model FlyingGroup {
  id          String    @id(map: "PK__FlyingGr__3213E83F620FD61F") @default("newid()", map: "DF__FlyingGroup__id__160F4887") @db.NVarChar(36)
  name        String    @db.NVarChar(255)
  description String?   @db.NVarChar(Max)
  ownerId     String    @db.NVarChar(36)
  dryRate     Decimal?  @db.Decimal(10, 2)
  wetRate     Decimal?  @db.Decimal(10, 2)
  customRates String?   @db.NVarChar(Max)
  createdAt   DateTime? @default(now(), map: "DF__FlyingGro__creat__17036CC0")
  updatedAt   DateTime? @default(now(), map: "DF__FlyingGro__updat__17F790F9") @updatedAt

  members     GroupMember[]
  invites     Invite[]

  @@map("FlyingGroup")
}

model GroupMember {
  id       String    @id(map: "PK__GroupMem__3213E83F73ED1832") @default("newid()", map: "DF__GroupMember__id__1BC821DD") @db.NVarChar(36)
  userId   String    @db.NVarChar(36)
  groupId  String    @db.NVarChar(36)
  role     String?   @default("VIEWER", map: "DF__GroupMembe__role__1CBC4616") @db.NVarChar(20)
  joinedAt DateTime? @default(now(), map: "DF__GroupMemb__joine__1DB06A4F")

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group    FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("GroupMember")
}

model Invite {
  id        String    @id(map: "PK__Invite__3213E83F3215783F") @default("newid()", map: "DF__Invite__id__2180FB33") @db.NVarChar(36)
  groupId   String    @db.NVarChar(36)
  token     String    @unique(map: "UQ__Invite__CA90DA7A533235A9") @db.NVarChar(255)
  email     String?   @db.NVarChar(255)
  role      String?   @default("VIEWER", map: "DF__Invite__role__22751F6C") @db.NVarChar(20)
  expiresAt DateTime
  createdBy String    @db.NVarChar(36)
  createdAt DateTime? @default(now(), map: "DF__Invite__createdA__236943A5")

  group     FlyingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("Invite")
}

model Maintenance {
  id           String    @id(map: "PK__Maintena__3213E83FBBF3C62C") @default("newid()", map: "DF__Maintenance__id__3493CFA7") @db.NVarChar(36)
  aircraftId   String    @db.NVarChar(36)
  userId       String    @db.NVarChar(36)
  description  String    @db.NVarChar(Max)
  status       String?   @default("NEEDED", map: "DF__Maintenan__statu__3587F3E0") @db.NVarChar(20)
  isGrounded   Boolean   @default(false)
  reportedDate DateTime? @default(now(), map: "DF__Maintenan__repor__367C1819")
  resolvedDate DateTime?
  cost         Decimal?  @db.Decimal(10, 2)
  notes        String?   @db.NVarChar(Max)
  createdAt    DateTime? @default(now(), map: "DF__Maintenan__creat__37703C52")
  updatedAt    DateTime? @default(now(), map: "DF__Maintenan__updat__3864608B") @updatedAt

  @@map("Maintenance")
}

model ClubAircraft {
  id               String    @id(map: "PK__ClubAirc__3213E83F197A971B") @default("newid()", map: "DF__ClubAircraft__id__2645B050") @db.NVarChar(36)
  groupId          String    @db.NVarChar(36)
  nNumber          String?   @db.NVarChar(10)
  nickname         String?   @db.NVarChar(100)
  customName       String?   @db.NVarChar(255)
  hourlyRate       Decimal?  @db.Decimal(10, 2)
  createdAt        DateTime? @default(now(), map: "DF__ClubAircr__creat__2739D489")
  updatedAt        DateTime? @default(now(), map: "DF__ClubAircr__updat__282DF8C2") @updatedAt
  make             String?   @db.NVarChar(100)
  model            String?   @db.NVarChar(100)
  year             Int?
  totalTachHours   Decimal?  @db.Decimal(6, 2)
  totalHobbsHours  Decimal?  @db.Decimal(6, 2)
  registrationType String?   @db.NVarChar(50)
  hasInsurance     Boolean?
  maxPassengers    Int?
  aircraftNotes    String?   @db.NVarChar(Max)
  status           String?   @db.NVarChar(50)

  @@map("ClubAircraft")
}

model Booking {
  id         String    @id(map: "PK__Booking__3213E83F64A346D6") @default("newid()", map: "DF__Booking__id__2B0A656D") @db.NVarChar(36)
  aircraftId String    @db.NVarChar(36)
  userId     String    @db.NVarChar(36)
  startTime  DateTime
  endTime    DateTime
  purpose    String?   @db.NVarChar(500)
  createdAt  DateTime? @default(now(), map: "DF__Booking__created__2BFE89A6")
  updatedAt  DateTime? @default(now(), map: "DF__Booking__updated__2CF2ADDF") @updatedAt

  @@map("Booking")
}

model FlightLog {
  id             String    @id(map: "PK__FlightLo__3213E83FB28F28FC") @default("newid()", map: "DF__FlightLog__id__2FCF1A8A") @db.NVarChar(36)
  aircraftId     String    @db.NVarChar(36)
  userId         String    @db.NVarChar(36)
  date           DateTime
  tachTime       Decimal?  @db.Decimal(6, 2)
  hobbsTime      Decimal?  @db.Decimal(6, 2)
  calculatedCost Decimal?  @db.Decimal(10, 2)
  notes          String?   @db.NVarChar(Max)
  createdAt      DateTime? @default(now(), map: "DF__FlightLog__creat__30C33EC3")
  updatedAt      DateTime? @default(now(), map: "DF__FlightLog__updat__31B762FC") @updatedAt
  hobbsStart     Decimal?  @db.Decimal(6, 2)
  hobbsEnd       Decimal?  @db.Decimal(6, 2)

  @@map("FlightLog")
}

model FlightPlan {
  id            String    @id @default(uuid()) @db.NVarChar(36)
  userId        String    @db.NVarChar(36)
  name          String?   @db.NVarChar(255)
  callsign      String?   @db.NVarChar(20)
  aircraftType  String?   @db.NVarChar(20)
  pilotName     String?   @db.NVarChar(100)
  departureIcao String?   @db.NVarChar(10)
  departureTime DateTime?
  departureFuel Int?
  arrivalIcao   String?   @db.NVarChar(10)
  alternateIcao String?   @db.NVarChar(10)
  cruisingAlt   Int?
  route         String?   @db.NVarChar(Max)
  remarks       String?   @db.NVarChar(Max)
  soulsOnBoard  Int?
  isFiled       Boolean   @default(false)
  filedAt       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  waypoints     FlightPlanWaypoint[]
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("FlightPlan")
}

model FlightPlanWaypoint {
  id           String   @id @default(uuid())
  flightPlanId String   @db.NVarChar(36)
  sequence     Int
  icao         String?  @db.NVarChar(10)
  name         String?  @db.NVarChar(100)
  city         String?  @db.NVarChar(100)
  waypointId   String?  @db.NVarChar(20)
  latitude     Float
  longitude    Float
  altitude     Int?
  flightType   String?  @db.NVarChar(10)
  createdAt    DateTime @default(now())

  flightPlan   FlightPlan @relation(fields: [flightPlanId], references: [id], onDelete: Cascade)

  @@map("FlightPlanWaypoint")
}

// ============ CACHE TABLES ============

model AirportCache {
  icao          String   @id @db.NVarChar(10)
  iata          String?  @db.NVarChar(3)
  name          String   @db.NVarChar(255)
  city          String?  @db.NVarChar(100)
  state         String?  @db.NVarChar(50)
  country       String?  @db.NVarChar(100)
  latitude      Float
  longitude     Float
  elevation_ft  Int?
  type          String   @db.NVarChar(50)  // large_airport, medium_airport, small_airport, seaplane_base, heliport
  timezone      String?  @db.NVarChar(50)
  hasTower      Boolean?
  hasWeather    Boolean?
  scraped_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([type])
  @@index([country, state])
  @@map("AirportCache")
}

model FuelPriceCache {
  icao           String   @id @db.NVarChar(10)
  price100ll     Decimal? @db.Decimal(6, 2)
  priceJetA      Decimal? @db.Decimal(6, 2)
  priceSulfar    Decimal? @db.Decimal(6, 2) // UL94
  source         String?  @db.NVarChar(50)  // airnav, fuel100, own
  source_url     String?  @db.NVarChar(500)
  last_reported  DateTime?
  attribution    String?  @db.NVarChar(255)
  scraped_at     DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([price100ll])
  @@map("FuelPriceCache")
}

model AircraftCache {
  id             Int      @id @default(autoincrement())
  manufacturer   String   @db.NVarChar(100)
  model          String   @db.NVarChar(200)
  year           Int?
  variant        String?  @db.NVarChar(100)
  
  // Engine specs
  engine_type    String?  @db.NVarChar(50)  // Piston, Turbine, Jet
  engine_count   Int?
  fuel_type      String?  @db.NVarChar(50)  // 100LL, JetA, UL94, Mogas
  fuel_capacity_gal Decimal? @db.Decimal(8, 2)
  fuel_capacityusable_gal Decimal? @db.Decimal(8, 2)
  
  // Performance - fuel saver relevant
  cruise_speed_kts Int?  // Typical cruise speed
  burn_rate_gph   Decimal? @db.Decimal(6, 2) // gallons per hour
  range_nm        Int?  // Range with full tanks
  range_with_reserve_nm Int? // Range with reserves (45min + 1hr)
  
  // Weights
  empty_weight_lbs Int?
  max_takeoff_weight_lbs Int?
  max_landing_weight_lbs Int?
  
  // Useful for planning
  pax_capacity   Int?
  useful_load_lbs Int?
  
  // Source
  source_url     String?  @db.NVarChar(500)
  is_verified    Boolean  @default(false)
  scraped_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@index([manufacturer, model])
  @@index([fuel_type])
  @@map("AircraftCache")
}

model WeatherCache {
  icao           String   @id @db.NVarChar(10)
  station_type   String?  @db.NVarChar(20)  // METAR, TAF
  raw_data       String   @db.NVarChar(Max)
  parsed_data    String?  @db.NVarChar(Max) // JSON parsed
  valid_from     DateTime
  valid_until    DateTime
  scraped_at     DateTime @default(now())

  @@index([valid_until])
  @@map("WeatherCache")
}

model Document {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  userId      String   @db.NVarChar(36)
  name        String   @db.NVarChar(255)
  type        String   @db.NVarChar(50) // POH, insurance, registration, maintenance, other
  fileUrl     String   @db.NVarChar(500)
  fileSize    Int?
  mimeType    String?  @db.NVarChar(100)
  description String?  @db.NVarChar(500)
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Document")
}

model ErrorReport {
  id          String   @id @default(uuid()) @db.NVarChar(36)
  userId      String?  @db.NVarChar(36) // null if anonymous
  email       String?  @db.NVarChar(255) // optional email for anonymous reports
  title       String   @db.NVarChar(255)
  description String   @db.NVarChar(Max)
  stepsToReproduce String? @db.NVarChar(Max)
  url         String?  @db.NVarChar(500) // page where error occurred
  browser     String?  @db.NVarChar(100) // browser info
  status      String   @default("open") @db.NVarChar(20) // open, in_progress, resolved, closed
  resolution  String?  @db.NVarChar(Max)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ErrorReport")
}
